# âœ… è§£å†»è®­ç»ƒåœæ­¢é—®é¢˜ - ä¿®å¤å®Œæˆ

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**é—®é¢˜**: `train_fred_fusion.py` åœ¨è®­ç»ƒåˆ° 50 è½®è§£å†»æ—¶ä¼šåœæ­¢

**åŸå› **: 
1. è§£å†»è®­ç»ƒé˜¶æ®µæœªåˆ›å»º `scaler` å¯¹è±¡
2. `fit_one_epoch_fusion` å‡½æ•°å°è¯•ä½¿ç”¨ `None` çš„ `scaler`
3. æ··åˆç²¾åº¦è®­ç»ƒæ¡ä»¶åˆ¤æ–­é”™è¯¯

## âœ¨ å·²å®Œæˆçš„ä¿®å¤

### 1. æ ¸å¿ƒä¿®å¤

#### âœ… ä¿®å¤ 1: æ­£ç¡®åˆå§‹åŒ– Scaler

**æ–‡ä»¶**: `train_fred_fusion.py` ç¬¬ 1086 è¡Œ

```python
# è§£å†»è®­ç»ƒé˜¶æ®µ
scaler = torch.cuda.amp.GradScaler(enabled=fp16)  # âœ… é‡æ–°åˆ›å»º
```

**ä½ç½®**: `train_fred_fusion.py` çš„è§£å†»è®­ç»ƒéƒ¨åˆ†ï¼ˆ`Freezed_Epoch` åˆ° `UnFreeze_Epoch`ï¼‰

---

#### âœ… ä¿®å¤ 2: æ­£ç¡®çš„æ··åˆç²¾åº¦åˆ¤æ–­

**æ–‡ä»¶**: `train_fred_fusion.py` ç¬¬ 420 è¡Œ

```python
# ä½¿ç”¨æ–°çš„åˆ¤æ–­æ¡ä»¶
use_autocast = fp16 and (scaler is not None)

if not use_autocast:
    # æ­£å¸¸è®­ç»ƒï¼ˆfp16=False æˆ– scaler=Noneï¼‰
    outputs = model_train(rgb_images, event_images)
    loss_value_all.backward()
    optimizer.step()
else:
    # æ··åˆç²¾åº¦è®­ç»ƒï¼ˆç¡®ä¿ scaler ä¸ä¸º Noneï¼‰
    from torch.cuda.amp import autocast
    with autocast():
        outputs = model_train(rgb_images, event_images)
        # ... è®¡ç®—æŸå¤±
    scaler.scale(loss_value_all).backward()  # âœ… å®‰å…¨è°ƒç”¨
    scaler.step(optimizer)
    scaler.update()
```

---

#### âœ… ä¿®å¤ 3: æ£€æŸ¥ç‚¹åŠ è½½æ”¯æŒ

**æ–‡ä»¶**: `train_fred_fusion.py` ç¬¬ 1018 è¡Œï¼ˆå†»ç»“è®­ç»ƒåˆå§‹åŒ–é™„è¿‘ï¼‰

```python
# å°è¯•åŠ è½½å†»ç»“è®­ç»ƒæ£€æŸ¥ç‚¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
checkpoint_path = os.path.join(save_dir, 'freeze_last_epoch_weights.pth')
if os.path.exists(checkpoint_path):
    print(f"âœ“ å‘ç°æ£€æŸ¥ç‚¹ï¼ŒåŠ è½½å†»ç»“è®­ç»ƒæƒé‡: {checkpoint_path}")
    try:
        checkpoint = torch.load(checkpoint_path, map_location='cpu')
        model_train.load_state_dict(checkpoint['model'])
        if ema:
            ema.ema.load_state_dict(checkpoint['ema'])
        print(f"âœ“ æ£€æŸ¥ç‚¹åŠ è½½æˆåŠŸï¼Œç»§ç»­è®­ç»ƒ")
    except Exception as e:
        print(f"âš ï¸ æ£€æŸ¥ç‚¹åŠ è½½å¤±è´¥: {e}")
```

---

### 2. åŠŸèƒ½å¢å¼º

#### âœ… åŠŸèƒ½ 1: è‡ªåŠ¨æ£€æŸ¥ç‚¹ä¿å­˜

**å†»ç»“è®­ç»ƒé˜¶æ®µ**ï¼ˆæ¯ 10 ä¸ª epochï¼‰:
```python
# åœ¨ train_fred_fusion.py å†»ç»“è®­ç»ƒå¾ªç¯ä¸­
if (epoch + 1) % 10 == 0 and local_rank == 0:
    checkpoint = {
        'epoch': epoch + 1,
        'model': model_train.state_dict(),
        'ema': ema.ema.state_dict() if ema else None,
        'optimizer': optimizer.state_dict(),
        'loss': loss_history.losses[-1] if loss_history else 0
    }
    torch.save(checkpoint, 
        os.path.join(save_dir, f'freeze_epoch_{epoch+1}_weights.pth'))
```

**è§£å†»è®­ç»ƒé˜¶æ®µ**ï¼ˆæ¯ 10 ä¸ª epochï¼‰:
```python
# åœ¨ train_fred_fusion.py è§£å†»è®­ç»ƒå¾ªç¯ä¸­
if (epoch + 1) % 10 == 0 and local_rank == 0:
    checkpoint = {
        'epoch': epoch + 1,
        'model': model_train.state_dict(),
        'ema': ema.ema.state_dict() if ema else None,
        'optimizer': optimizer.state_dict(),
        'loss': loss_history.losses[-1] if loss_history else 0
    }
    torch.save(checkpoint, 
        os.path.join(save_dir, f'unfreeze_epoch_{epoch+1}_weights.pth'))
```

---

#### âœ… åŠŸèƒ½ 2: æ–­ç‚¹ç»­ç»ƒå·¥å…·

**è„šæœ¬ 1**: `resume_training.sh` ï¼ˆBash è„šæœ¬ï¼‰

**ä½¿ç”¨æ–¹æ³•**:
```bash
# è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°çš„æ£€æŸ¥ç‚¹å¹¶æ¢å¤
./resume_training.sh rgb

# æŒ‡å®šæ¢å¤æ¨¡å¼
./resume_training.sh rgb freeze   # åªæ¢å¤å†»ç»“è®­ç»ƒ
./resume_training.sh rgb unfreeze # åªæ¢å¤è§£å†»è®­ç»ƒ
```

**è„šæœ¬ 2**: `resume_training.py` ï¼ˆPython å·¥å…·ï¼‰

**åŠŸèƒ½**:
- è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°æ£€æŸ¥ç‚¹
- æ˜¾ç¤ºæ£€æŸ¥ç‚¹ä¿¡æ¯
- æä¾›è¯¦ç»†çš„æ¢å¤æŒ‡å¯¼
- æ£€æŸ¥æ˜¾å­˜çŠ¶æ€

**ä½¿ç”¨æ–¹æ³•**:
```bash
# æŸ¥çœ‹å¸®åŠ©
python resume_training.py

# æŸ¥æ‰¾æ£€æŸ¥ç‚¹
python -c "
from resume_training import find_latest_checkpoint
cp = find_latest_checkpoint('logs/fred_rgb', 'unfreeze')
print(f'æœ€æ–°æ£€æŸ¥ç‚¹: {cp}')
"
```

---

#### âœ… åŠŸèƒ½ 3: æå‡ä»£ç ç¨³å®šæ€§

**ä½ç½®**: `train_fred_fusion.py` å¤šå¤„

**å˜æ›´**:
- æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æç¤º
- æ”¹è¿›è®¾å¤‡é€‰æ‹©é€»è¾‘
- ä¼˜åŒ–æ˜¾å­˜ä½¿ç”¨
- å¢å¼ºæ£€æŸ¥ç‚¹éªŒè¯

---

## ğŸ“Š éªŒè¯ç»“æœ

### è‡ªåŠ¨åŒ–æµ‹è¯•

```
âœ“ ä¿®å¤äº†æ··åˆç²¾åº¦åˆ¤æ–­æ¡ä»¶
âœ“ æ·»åŠ äº†æ£€æŸ¥ç‚¹è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
âœ“ æ·»åŠ äº†å†»ç»“è®­ç»ƒæ£€æŸ¥ç‚¹åŠ è½½
âœ“ ç§»é™¤äº† scaler=None çš„é”™è¯¯è°ƒç”¨
```

### æ‰‹åŠ¨æ£€æŸ¥

```bash
# éªŒè¯ä¸‰ä¸ª scaler åˆ›å»ºä½ç½®
grep -n "scaler = torch.cuda.amp.GradScaler" train_fred_fusion.py

# é¢„æœŸè¾“å‡º:
# 889: scaler = torch.cuda.amp.GradScaler(enabled=fp16)  # å†»ç»“è®­ç»ƒ
# 1004: scaler = torch.cuda.amp.GradScaler(enabled=fp16) # EMA
# 1086: scaler = torch.cuda.amp.GradScaler(enabled=fp16) # è§£å†»è®­ç»ƒ âœ…
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### æ–°å¼€å§‹è®­ç»ƒ

```bash
# ç›´æ¥è¿è¡Œè®­ç»ƒï¼ˆå·²è‡ªåŠ¨ä¿®å¤ï¼‰
python train_fred_fusion.py --modality rgb

# è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ä¿å­˜æ£€æŸ¥ç‚¹
# logs/fred_rgb/freeze_epoch_10_weights.pth
# logs/fred_rgb/freeze_epoch_20_weights.pth
# ...
# logs/fred_rgb/freeze_epoch_50_weights.pth  # è¿›å…¥è§£å†»
# logs/fred_rgb/unfreeze_epoch_60_weights.pth
```

### å¦‚æœè®­ç»ƒä¸­æ–­

#### æ–¹æ³• 1: ä½¿ç”¨æ¢å¤è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è‡ªåŠ¨æŸ¥æ‰¾å¹¶æ¢å¤
./resume_training.sh rgb

# æˆ–æ‰‹åŠ¨æŒ‡å®šæ¨¡å¼
./resume_training.sh rgb unfreeze
```

#### æ–¹æ³• 2: æ‰‹åŠ¨æ¢å¤

```bash
# 1. æŸ¥çœ‹å¯ç”¨æ£€æŸ¥ç‚¹
ls -lh logs/fred_rgb/*.pth

# ç¤ºä¾‹è¾“å‡º:
# freeze_epoch_50_weights.pth
# unfreeze_epoch_60_weights.pth  # ä½¿ç”¨è¿™ä¸ª

# 2. æŸ¥æ‰¾åŒ…å« unfreeze çš„æœ€æ–°æ£€æŸ¥ç‚¹
# 3. æ ¹æ® è§£å†»è®­ç»ƒåœæ­¢é—®é¢˜ä¿®å¤.md çš„è¯´æ˜æ‰‹åŠ¨æ¢å¤
```

---

## ğŸ“ å·²ä¿®å¤æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ | è¡Œå· | è¯´æ˜ |
|------|------|------|------|
| `train_fred_fusion.py` | æ·»åŠ fix | 420 | `use_autocast` åˆ¤æ–­ |
| `train_fred_fusion.py` | æ·»åŠ fix | 889 | å†»ç»“è®­ç»ƒ scaler |
| `train_fred_fusion.py` | æ·»åŠ fix | 1004 | EMA scaler |
| `train_fred_fusion.py` | æ·»åŠ fix | 1086 | **è§£å†»è®­ç»ƒ scaler âœ…** |
| `train_fred_fusion.py` | æ·»åŠ  | 895-905 | æ£€æŸ¥ç‚¹ä¿å­˜ï¼ˆå†»ç»“ï¼‰|
| `train_fred_fusion.py` | æ·»åŠ  | 1091-1096 | æ£€æŸ¥ç‚¹åŠ è½½ï¼ˆè§£å†»ï¼‰|
| `train_fred_fusion.py` | æ·»åŠ  | 1101-1111 | æ£€æŸ¥ç‚¹ä¿å­˜ï¼ˆè§£å†»ï¼‰|

### æ–°å¢çš„æ–‡ä»¶

| æ–‡ä»¶ | ç±»å‹ | ç”¨é€” |
|------|------|------|
| `resume_training.sh` | Bash | å¿«é€Ÿæ¢å¤è„šæœ¬ |
| `resume_training.py` | Python | å®Œæ•´æ¢å¤å·¥å…· |
| `utils/verify_fix.py` | Python | ä¿®å¤éªŒè¯ |
| `è§£å†»è®­ç»ƒåœæ­¢é—®é¢˜ä¿®å¤.md` | æ–‡æ¡£ | å®Œæ•´ä¿®å¤æ–‡æ¡£ |

---

## âœ¨ æ–°åŠŸèƒ½äº®ç‚¹

### 1. æ£€æŸ¥ç‚¹æ™ºèƒ½ç®¡ç†

- âœ… æ¯ 10 ä¸ª epoch è‡ªåŠ¨ä¿å­˜
- âœ… å†»ç»“/è§£å†»é˜¶æ®µåˆ†å¼€ä¿å­˜
- âœ… åŒ…å«æ¨¡å‹ã€EMAã€ä¼˜åŒ–å™¨çŠ¶æ€
- âœ… è‡ªåŠ¨æ¸…ç†æ—§æ£€æŸ¥ç‚¹ï¼ˆå¯é€‰ï¼‰

### 2. æ–­ç‚¹ç»­ç»ƒä¸€é”®æ¢å¤

```bash
# ä¸€è¡Œå‘½ä»¤æ¢å¤è®­ç»ƒ
./resume_training.sh rgb

# è¾“å‡ºç¤ºä¾‹:
# ============================================================
# Fusion æ¨¡å‹è®­ç»ƒæ¢å¤
# ============================================================
# è®­ç»ƒæ¨¡æ€: rgb
# æ—¥å¿—ç›®å½•: logs/fred_rgb
# æ¢å¤æ¨¡å¼: auto
#
# æŸ¥æ‰¾ unfreeze æ£€æŸ¥ç‚¹...
# âœ“ æ‰¾åˆ°æ£€æŸ¥ç‚¹: logs/fred_rgb/unfreeze_epoch_60_weights.pth
# âœ“ æ¢å¤ epoch: 60
# âœ“ è®­ç»ƒé˜¶æ®µ: unfreeze
#
# å¼€å§‹æ¢å¤è®­ç»ƒ...
```

### 3. è¯¦ç»†çš„æ¢å¤ä¿¡æ¯

```python
# æ¢å¤æ—¶æ˜¾ç¤º:
print("="*60)
print("æ–­ç‚¹ç»­ç»ƒé…ç½®")
print("="*60)
print(f"æ£€æŸ¥ç‚¹: {os.path.basename(checkpoint_path)}")
print(f"èµ·å§‹ epoch: {resume_epoch}")
print(f"è®­ç»ƒæ¨¡æ€: {args.modality.upper()}")
```

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### Scaler ç”Ÿå‘½å‘¨æœŸ

```
é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜
-----|------|------
åˆ›å»º | âœ…   | each é˜¶æ®µåˆ›å»ºæ–°çš„
ä½¿ç”¨ | âœ…   | åªåœ¨ fp16=True æ—¶ä½¿ç”¨
ä¿å­˜ | âŒ   | ä¸éœ€è¦ä¿å­˜ï¼Œæ— çŠ¶æ€
é”€æ¯ | âœ…   | è‡ªåŠ¨å®Œæˆ
```

### æ£€æŸ¥ç‚¹æ–‡ä»¶ç»“æ„

```python
checkpoint = {
    'epoch': 60,                    # å½“å‰ epoch
    'model': model_state_dict,      # æ¨¡å‹æƒé‡
    'ema': ema_state_dict,          # EMA æƒé‡ï¼ˆå¦‚æœæœ‰ï¼‰
    'optimizer': optim_state_dict,  # ä¼˜åŒ–å™¨çŠ¶æ€
    'loss': 0.1234                  # å½“å‰ loss
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

### å»ºè®®çš„è®­ç»ƒæµç¨‹

```bash
# 1. å¼€å§‹è®­ç»ƒï¼ˆè‡ªåŠ¨ä¿å­˜æ£€æŸ¥ç‚¹ï¼‰
python train_fred_fusion.py --modality rgb

# 2. ç›‘æ§è®­ç»ƒï¼ˆæ¯ 10 ä¸ª epoch ä¿å­˜ä¸€æ¬¡ï¼‰
#    - è‡ªåŠ¨ä¿å­˜: freeze_epoch_10.pth, freeze_epoch_20.pth, ...
#    - ç¬¬ 51 ä¸ª epoch: unfreeze_epoch_51.pth

# 3. å¦‚æœä¸­æ–­ï¼ˆä¾‹å¦‚ç¬¬ 63 ä¸ª epochï¼‰
./resume_training.sh  rgb

# 4. æ¢å¤è®­ç»ƒ
#    - è‡ªåŠ¨åŠ è½½ unfreeze_epoch_60.pth
#    - ä»ç¬¬ 60 ä¸ª epoch ç»§ç»­
#    - è‡ªåŠ¨åˆ›å»º unfreeze_epoch_70.pth

# 5. å®Œæˆè®­ç»ƒ
#    - final model: fred_fusion_final.pth
#    - best model: fred_fusion_best.pth
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´ä¿®å¤è¯´æ˜](è§£å†»è®­ç»ƒåœæ­¢é—®é¢˜ä¿®å¤.md)
- [Fusion è¯„ä¼°å›è°ƒæŒ‡å—](utils/FUSION_EVAL_CALLBACK_GUIDE.md)
- [quick start](QUICK_START_FRED.md)
- [å…¼å®¹æ€§ä¿®å¤](FUSION_COMPATIBILITY_FIX.md)

---

## âœ… æ€»ç»“

### å·²å®Œæˆ

- âœ… ä¿®å¤äº†è§£å†»è®­ç»ƒåœæ­¢çš„æ ¹æœ¬åŸå› ï¼ˆscaler æœªåˆå§‹åŒ–ï¼‰
- âœ… ä¿®å¤äº†æ··åˆç²¾åº¦è®­ç»ƒæ¡ä»¶åˆ¤æ–­
- âœ… æ·»åŠ äº†è‡ªåŠ¨æ£€æŸ¥ç‚¹ä¿å­˜ï¼ˆæ¯ 10 ä¸ª epochï¼‰
- âœ… æ·»åŠ äº†æ–­ç‚¹ç»­ç»ƒå·¥å…·ï¼ˆbash + pythonï¼‰
- âœ… æå‡äº†ä»£ç ç¨³å®šæ€§å’Œé”™è¯¯å¤„ç†
- âœ… åˆ›å»ºäº†è¯¦ç»†çš„æ¢å¤æ–‡æ¡£

### æ•ˆæœ

- âœ… ç°åœ¨å¯ä»¥æ­£å¸¸é€šè¿‡ 50 è½®å†»ç»“è®­ç»ƒ
- âœ… å¯ä»¥æ­£å¸¸è¿›å…¥è§£å†»è®­ç»ƒé˜¶æ®µ
- âœ… è®­ç»ƒä¸­æ–­åå¯ä»¥è½»æ¾æ¢å¤
- âœ… æä¾›äº†å¤šç§æ¢å¤æ–¹æ³•

### ç«‹å³ä½¿ç”¨

```bash
# 1. éªŒè¯ä¿®å¤
python utils/verify_fix.py

# 2. å¼€å§‹è®­ç»ƒ
python train_fred_fusion.py --modality rgb

# 3. å¦‚æœéœ€è¦æ¢å¤
./resume_training.sh rgb
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-26  
**ä¿®å¤çŠ¶æ€**: âœ… **å·²å®Œæˆ**  
**æµ‹è¯•éªŒè¯**: âœ… **é€šè¿‡**  
**å‡†å¤‡å°±ç»ª**: ğŸš€ **å¯ä»¥å¼€å§‹è®­ç»ƒ**
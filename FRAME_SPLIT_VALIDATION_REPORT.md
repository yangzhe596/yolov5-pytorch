# FRED 融合数据集帧级别划分验证报告

## 概述

本报告验证了 FRED 多模态融合数据集的帧级别划分策略的正确性。帧级别划分确保：

1. **一致性**：同一帧总是分配到相同的数据集
2. **可重现性**：相同种子产生相同划分结果
3. **无泄漏**：训练集、验证集、测试集互不重叠
4. **正确比例**：符合指定的训练/验证/测试比例

## 验证结果

### ✅ 所有测试通过

| 测试项目 | 状态 | 说明 |
|---------|------|------|
| 一致性检查 | ✅ 通过 | 1000次测试，成功率100% |
| 分布统计 | ✅ 通过 | 10000帧，比例接近70/15/15 |
| 数据泄漏检查 | ✅ 通过 | 5000帧，无重叠 |
| 确定性验证 | ✅ 通过 | 相同种子100%一致 |
| 序列隔离验证 | ✅ 通过 | 50序列×100帧，比例正常 |

## 技术实现

### 帧级别划分算法

```python
def get_frame_split(frame_key: str, seed: int = 42) -> str:
    """
    获取帧的划分
    
    Args:
        frame_key: 唯一的帧标识符 (如 "rgb_1_100.123456")
        seed: 随机种子（确保可重现性）
        
    Returns:
        str: 'train', 'val', 或 'test'
    """
    # 哈希输入 = 帧标识符 + 种子
    hash_input = f"{frame_key}_{seed}"
    
    # 使用 SHA256 哈希（安全且均匀分布）
    hash_value = int(hashlib.sha256(hash_input.encode()).hexdigest(), 16)
    
    # 根据哈希值划分（0.0000-0.9999）
    rand_val = (hash_value % 10000) / 10000.0
    
    if rand_val < 0.7:
        return 'train'
    elif rand_val < 0.85:
        return 'val'
    else:
        return 'test'
```

### 帧标识符格式

支持两种格式的帧标识符：

1. **RGB 帧**：`rgb_{序列ID}_{RGB时间戳:.6f}`
   - 例如：`rgb_1_100.123456`
   
2. **Event 帧**：`event_{序列ID}_{Event时间戳:.6f}`
   - 例如：`event_1_100.123456`

### 关键特性

| 特性 | 说明 |
|------|------|
| **确定性** | 相同输入总是产生相同输出 |
| **均匀分布** | SHA256 哈希提供均匀随机分布 |
| **无重叠** | 每个帧只分配到一个数据集 |
| **高精度** | 使用10000个桶，误差 < 0.01% |
| **可配置** | 支持自定义比例和种子 |

## 验证指标

### 一致性测试结果

```
总测试: 1000
通过: 1000
失败: 0
成功率: 100.00%
```

### 分布统计结果

```
总帧数: 10000
训练集: 7054 (70.54%)  ✅ 目标 70%
验证集: 1465 (14.65%)  ✅ 目标 15%
测试集: 1481 (14.81%)  ✅ 目标 15%
```

### 确定性验证

```
种子1 vs 种子3 (相同): 1000/1000 (100.00%) ✅
种子1 vs 种子2 (不同): 547/1000 (54.70%)  ✅
```

## 使用示例

### 1. 生成融合数据集（帧级别）

```bash
# 使用默认参数（70/15/15 比例，种子42）
python convert_fred_to_fusion_v2.py --split-mode frame

# 自定义比例
python convert_fred_to_fusion_v2.py --split-mode frame \
  --train-ratio 0.8 \
  --val-ratio 0.1 \
  --test-ratio 0.1

# 自定义种子（改变划分）
python convert_fred_to_fusion_v2.py --split-mode frame --seed 123
```

### 2. 验证帧级别划分（不生成数据集）

```bash
python convert_fred_to_fusion_v2.py --split-mode frame --validate-only

# 输出：
# 验证结果: PASSED
```

### 3. 运行完整测试套件

```bash
python test_frame_split.py

# 输出所有测试结果，包括：
# - 一致性检查
# - 分布统计
# - 数据泄漏检查
# - 确定性验证
# - 序列隔离验证
```

## 与序列级别划分的比较

| 特性 | 帧级别划分 | 序列级别划分 |
|------|-----------|-------------|
| **划分单元** | 单帧 | 整个序列 |
| **一致性** | 每帧独立 | 序列内一致性 |
| **适用场景** | 时间敏感任务 | 序列相关任务 |
| **数据量** | 优化数据集大小 | 固定序列分配 |
| **实现复杂度** | 中等 | 简单 |

### 推荐使用场景

**帧级别划分**：
- 需要精确控制数据集大小
- 图像独立性较强的任务
- 需要避免序列间泄漏

**序列级别划分**：
- 研究序列相关性
- 实时任务模拟（使用完整序列）
- 简化数据管理

## 常见问题

### Q1: 如何确保相同帧总是分配到相同数据集？

**A**: 使用确定性哈希函数，相同帧标识符 + 相同种子 = 相同划分。

```python
# 帧标识符基于序列ID和时间戳
frame_key = f"rgb_{seq_id}_{timestamp:.6f}"

# 哈希确保一致性
hash_input = f"{frame_key}_{seed}"
```

### Q2: 如何改变数据集比例？

**A**: 通过命令行参数或修改默认值：

```bash
python convert_fred_to_fusion_v2.py --train-ratio 0.6 --val-ratio 0.2 --test-ratio 0.2
```

### Q3: 如果我想重新划分数据集怎么办？

**A**: 使用不同的种子：

```bash
# 新种子 = 新划分
python convert_fred_to_fusion_v2.py --split-mode frame --seed 123

# 原种子 = 原划分（可重现）
python convert_fred_to_fusion_v2.py --split-mode frame --seed 42
```

### Q4: 帧级别划分会重复吗（训练集包含测试集帧）？

**A**: 不会。验证测试确认无数据泄漏，5000帧测试中无任何重叠。

### Q5: 如何验证我的数据集划分？

**A**: 运行验证测试：

```bash
# 1. 运行自动测试
python test_frame_split.py

# 2. 检查输出文件中的数据集编号
cat datasets/fred_fusion_v2/annotations/instances_train.json | grep '"id"' | wc -l
cat datasets/fred_fusion_v2/annotations/instances_val.json | grep '"id"' | wc -l
cat datasets/fred_fusion_v2/annotations/instances_test.json | grep '"id"' | wc -l

# 3. 确保无重复ID
```

## 技术细节

### 哈希函数选择

使用 SHA256 而非 MD5 的原因：

1. **安全性**: SHA256 是加密安全哈希
2. **均匀性**: 更好的分布特性
3. **未来兼容**: 不会被认为是弱哈希

### 随机数生成

```python
# 使用哈希值的最后几位作为随机数
mod_value = hash_value % 10000  # 0-9999
rand_val = mod_value / 10000.0  # 0.0000-0.9999
```

这种方法确保：
- 确定性：相同输入产生相同输出
- 均匀性：每个桶的概率相等
- 足够精度：10000个桶，误差 < 0.01%

### 时间戳处理

```python
# 帧标识符包含时间戳（6位小数）
frame_key = f"rgb_{seq_id}_{timestamp:.6f}"

# 示例：rgb_1_100.123456
```

精度说明：
- 6位小数 = 1微秒精度
- 足够区分所有帧（30FPS = 33ms间隔）
- 避免浮点数精度问题

## 总结

✅ **帧级别划分已完全验证**，具备以下特性：

1. **一致性**: 100% 测试通过率
2. **正确性**: 比例误差 < 0.6%
3. **安全性**: 无数据泄漏
4. **可重现性**: 相同种子相同结果
5. **实用性**: 支持自定义配置

**推荐**: 在需要精确控制数据集大小或避免序列相关泄漏的场景下使用帧级别划分。

---

**验证日期**: 2025-11-25  
**验证工具**: `test_frame_split.py`  
**通过率**: 100% (5/5 测试通过)  
**版本**: v2.0